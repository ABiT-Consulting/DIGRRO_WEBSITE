trigger:
  branches:
    include:
      - main
      - master

pr:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  node_version: '20.x'
  npm_config_cache: $(Pipeline.Workspace)/.npm
  run_selenium_tests: 'false'

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: $(node_version)
    displayName: Install Node.js

  - task: Cache@2
    inputs:
      key: 'npm | "$(Agent.OS)" | package-lock.json'
      restoreKeys: |
        npm | "$(Agent.OS)"
      path: $(npm_config_cache)
    displayName: Cache npm

  - script: npm ci
    displayName: Install dependencies
    env:
      npm_config_cache: $(npm_config_cache)

  - script: npm run lint
    displayName: Lint

  - script: npm run typecheck
    displayName: Typecheck

  - script: npm run build
    displayName: Build

  - script: npm run test:selenium
    displayName: Selenium tests
    condition: and(succeeded(), eq(variables.run_selenium_tests, 'true'))

  - task: PublishBuildArtifacts@1
    inputs:
      PathtoPublish: dist
      ArtifactName: web-dist
      publishLocation: Container
    displayName: Publish dist
